<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pink Ultra - Fluid Workspace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0b0b1a;
            --pink: #ff00ff;
            --blue: #00d2ff;
            --panel: rgba(15, 15, 35, 0.85);
        }

        * { box-sizing: border-box; outline: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white;
            font-family: 'Inter', sans-serif; overflow: hidden;
        }

        /* Contenedor de la Pizarra */
        #viewport {
            width: 100vw; height: 100vh;
            cursor: grab;
            perspective: 1000px;
            background: radial-gradient(circle at center, #1a1a3a 0%, #0b0b1a 100%);
        }

        #canvas-wrapper {
            position: absolute;
            width: 10000px; height: 10000px;
            top: 0; left: 0;
            transform-origin: 0 0;
            will-change: transform; /* Optimización de rendimiento */
        }

        /* Cuadrícula infinita */
        .grid {
            position: absolute; inset: 0;
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        /* Herramientas Flotantes */
        .ui-dock {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            backdrop-filter: blur(20px);
            padding: 12px 25px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 15px; align-items: center;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        .tool-btn {
            background: none; border: none; color: white;
            font-size: 1.3rem; cursor: pointer; transition: 0.2s;
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: var(--pink); color: black; transform: translateY(-5px); }
        .tool-btn.active { background: var(--blue); color: black; }

        /* Elementos (Notas/Nodos) */
        .element {
            position: absolute; min-width: 200px; min-height: 150px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: move;
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            will-change: top, left;
        }

        .element.note { background: rgba(255, 240, 100, 0.9); color: #222; border: none; }
        .element.node { border: 2px solid var(--pink); border-radius: 50px; background: rgba(255,0,255,0.1); }

        .el-header { padding: 8px; display: flex; justify-content: flex-end; gap: 8px; opacity: 0; transition: 0.3s; }
        .element:hover .el-header { opacity: 1; }
        .el-content { flex-grow: 1; padding: 15px; text-align: center; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem; }

        /* SVG para Flechas */
        #svg-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1; }
        canvas#draw-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }
        canvas#draw-layer.active { pointer-events: all; cursor: crosshair; }
    </style>
</head>
<body>

    <div class="ui-dock">
        <h2 style="font-size: 1rem; color: var(--pink); margin: 0 15px 0 0; letter-spacing: 2px;">PINK</h2>
        <button class="tool-btn" onclick="addNote()"><i class="fas fa-sticky-note"></i></button>
        <button class="tool-btn" onclick="addNode()"><i class="fas fa-project-diagram"></i></button>
        <button class="tool-btn" onclick="document.getElementById('img-up').click()"><i class="fas fa-image"></i></button>
        <button class="tool-btn" id="draw-toggle" onclick="toggleDraw()"><i class="fas fa-pen-nib"></i></button>
        <input type="color" id="picker" value="#ff00ff" style="width:30px; border:none; background:none; cursor:pointer;">
        <button class="tool-btn" onclick="clearBoard()"><i class="fas fa-trash-alt"></i></button>
    </div>

    <input type="file" id="img-up" hidden accept="image/*">

    <div id="viewport">
        <div id="canvas-wrapper">
            <div class="grid"></div>
            <svg id="svg-layer"></svg>
            <canvas id="draw-layer"></canvas>
        </div>
    </div>

    <script>
        const viewport = document.getElementById('viewport');
        const wrapper = document.getElementById('canvas-wrapper');
        const drawCanvas = document.getElementById('draw-layer');
        const ctx = drawCanvas.getContext('2d');
        const svg = document.getElementById('svg-layer');

        let scale = 1;
        let posX = -4000, posY = -4000; // Centrar inicialmente
        let isPanning = false;
        let isDrawing = false;
        let canDraw = false;
        let connections = [];

        // Inicialización
        function init() {
            drawCanvas.width = 10000;
            drawCanvas.height = 10000;
            updateTransform();
        }

        // --- ZOOM CON LA RUEDA (MOUSE WHEEL) ---
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = -e.deltaY;
            const factor = delta > 0 ? 1.1 : 0.9;
            
            // Zoom centrado en el mouse
            const rect = viewport.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const wx = (mouseX - posX) / scale;
            const wy = (mouseY - posY) / scale;

            scale *= factor;
            scale = Math.min(Math.max(0.1, scale), 5); // Limites de zoom

            posX = mouseX - wx * scale;
            posY = mouseY - wy * scale;

            updateTransform();
        }, { passive: false });

        // --- MOVIMIENTO (PANNING) ---
        viewport.addEventListener('mousedown', (e) => {
            if (e.button === 1 || !canDraw) { // Botón medio o modo pan
                isPanning = true;
                viewport.style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (isPanning) {
                posX += e.movementX;
                posY += e.movementY;
                updateTransform();
            }
        });

        window.addEventListener('mouseup', () => {
            isPanning = false;
            viewport.style.cursor = canDraw ? 'crosshair' : 'grab';
        });

        function updateTransform() {
            wrapper.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        // --- DIBUJO ---
        function toggleDraw() {
            canDraw = !canDraw;
            document.getElementById('draw-toggle').classList.toggle('active');
            drawCanvas.classList.toggle('active');
            viewport.style.cursor = canDraw ? 'crosshair' : 'grab';
        }

        drawCanvas.onmousedown = (e) => {
            if (!canDraw) return;
            isDrawing = true;
            ctx.beginPath();
            const rect = drawCanvas.getBoundingClientRect();
            ctx.moveTo((e.clientX - rect.left) / scale, (e.clientY - rect.top) / scale);
        };

        drawCanvas.onmousemove = (e) => {
            if (!isDrawing) return;
            const rect = drawCanvas.getBoundingClientRect();
            ctx.lineTo((e.clientX - rect.left) / scale, (e.clientY - rect.top) / scale);
            ctx.strokeStyle = document.getElementById('picker').value;
            ctx.lineWidth = 5 / scale;
            ctx.lineCap = 'round';
            ctx.stroke();
        };

        drawCanvas.onmouseup = () => isDrawing = false;

        // --- ELEMENTOS ---
        function addNote() { createEl('note', 'Nueva Nota'); }
        function addNode() { createEl('node', 'Concepto'); }

        function createEl(type, text) {
            const el = document.createElement('div');
            el.className = `element ${type}`;
            // Spawnea en el centro de la pantalla actual
            el.style.left = (Math.abs(posX) + window.innerWidth/2) / scale + 'px';
            el.style.top = (Math.abs(posY) + window.innerHeight/2) / scale + 'px';

            el.innerHTML = `
                <div class="el-header">
                    <i class="fas fa-plus" onclick="addChild(this.parentElement.parentElement)"></i>
                    <i class="fas fa-trash" onclick="removeEl(this.parentElement.parentElement)"></i>
                </div>
                <div class="el-content" contenteditable="true">${text}</div>
            `;

            wrapper.appendChild(el);
            makeDraggable(el);
            new ResizeObserver(() => updateLines()).observe(el);
            return el;
        }

        function addChild(parent) {
            const child = createEl('node', 'Hijo');
            child.style.left = (parseFloat(parent.style.left) + 300) + 'px';
            child.style.top = parent.style.top;
            connections.push({from: parent, to: child});
            updateLines();
        }

        function makeDraggable(el) {
            let startX, startY;
            el.onmousedown = (e) => {
                if (e.target.contentEditable === "true" || e.target.classList.contains('fas')) return;
                e.stopPropagation();
                startX = e.clientX; startY = e.clientY;
                
                const move = (e) => {
                    const dx = (e.clientX - startX) / scale;
                    const dy = (e.clientY - startY) / scale;
                    el.style.left = (el.offsetLeft + dx) + 'px';
                    el.style.top = (el.offsetTop + dy) + "px";
                    startX = e.clientX; startY = e.clientY;
                    updateLines();
                };
                
                const up = () => {
                    window.removeEventListener('mousemove', move);
                    window.removeEventListener('mouseup', up);
                };
                
                window.addEventListener('mousemove', move);
                window.addEventListener('mouseup', up);
            };
        }

        function updateLines() {
            svg.innerHTML = '';
            connections.forEach(c => {
                if (!c.from.parentElement || !c.to.parentElement) return;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const x1 = c.from.offsetLeft + c.from.offsetWidth;
                const y1 = c.from.offsetTop + c.from.offsetHeight / 2;
                const x2 = c.to.offsetLeft;
                const y2 = c.to.offsetTop + c.to.offsetHeight / 2;
                const d = `M ${x1} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2} ${y2}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#ff00ff');
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
            });
        }

        // --- IMÁGENES ---
        document.getElementById('img-up').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = document.createElement('div');
                img.className = 'element';
                img.style.left = (Math.abs(posX) + 100)/scale + 'px';
                img.style.top = (Math.abs(posY) + 100)/scale + 'px';
                img.innerHTML = `<img src="${f.target.result}" style="width:100%; height:100%; object-fit:contain; pointer-events:none; border-radius:10px;">`;
                wrapper.appendChild(img);
                makeDraggable(img);
            };
            reader.readAsDataURL(file);
        };

        function removeEl(el) { el.remove(); updateLines(); }
        function clearBoard() { if(confirm('¿Limpiar todo?')) location.reload(); }

        init();
    </script>
</body>
</html>
