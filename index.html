<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pink Ultra - Infinite Canvas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --dark-bg: #0f0c29;
            --gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --pink: #ff00ff;
            --cyan: #00d2ff;
            --glass: rgba(255, 255, 255, 0.05);
            --panel-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--dark-bg); color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }

        /* El Lienzo Infinito */
        #master-container {
            width: 100vw; height: 100vh;
            background: var(--gradient);
            position: relative;
            cursor: grab;
            overflow: hidden;
        }

        #infinite-canvas {
            position: absolute;
            width: 5000px; height: 5000px;
            top: -2000px; left: -2000px;
            transform-origin: center;
        }

        /* Cuadrícula de fondo */
        .grid-bg {
            position: absolute; inset: 0;
            background-image: radial-gradient(rgba(255, 0, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        /* Paneles de Herramientas */
        .ui-panel {
            position: fixed; background: rgba(15, 12, 41, 0.8);
            backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; box-shadow: var(--panel-shadow); z-index: 1000;
            padding: 10px; display: flex; gap: 8px;
        }

        .toolbar-left { left: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; }
        .toolbar-top { top: 20px; left: 50%; transform: translateX(-50%); align-items: center; padding: 10px 20px; }

        .btn {
            width: 45px; height: 45px; border-radius: 10px; border: none;
            background: transparent; color: #fff; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .btn:hover { background: var(--pink); color: #000; box-shadow: 0 0 15px var(--pink); }
        .btn.active { background: var(--cyan); color: #000; }

        /* Elementos: Notas, Nodos, Imagenes */
        .element {
            position: absolute; min-width: 180px; min-height: 120px;
            border-radius: 12px; cursor: move; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05); backdrop-filter: blur(5px);
            resize: both; overflow: hidden; padding: 10px;
        }

        .note-pro { background: #fff3a0; color: #333; border: none; }
        .node-pro { 
            background: linear-gradient(45deg, #7b2ff7, #f107a3); 
            border: 2px solid #fff; border-radius: 50px; text-align: center;
        }

        .content-area { 
            flex-grow: 1; outline: none; padding: 10px; 
            font-weight: 500; display: flex; align-items: center; justify-content: center;
        }

        /* SVG para Conexiones */
        #svg-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1; }

        /* Canvas de dibujo */
        #draw-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }
        #draw-layer.active { pointer-events: all; }

        /* Branding */
        .brand { font-weight: bold; color: var(--pink); margin-right: 15px; letter-spacing: 2px; }

    </style>
</head>
<body>

    <div class="ui-panel toolbar-top">
        <div class="brand">PINK ULTRA</div>
        <button class="btn" onclick="addNote()" title="Nota Adhesiva"><i class="fas fa-sticky-note"></i></button>
        <button class="btn" onclick="addNode()" title="Nodo de Esquema"><i class="fas fa-circle-nodes"></i></button>
        <button class="btn" onclick="document.getElementById('file-input').click()" title="Subir Imagen"><i class="fas fa-image"></i></button>
        <div style="width:2px; height:30px; background:rgba(255,255,255,0.1); margin: 0 10px;"></div>
        <button class="btn" onclick="setTool('pan')" id="btn-pan" title="Mover Pizarra"><i class="fas fa-hand-paper"></i></button>
        <button class="btn" onclick="setTool('draw')" id="btn-draw" title="Dibujar"><i class="fas fa-pen"></i></button>
        <button class="btn" onclick="clearAll()" title="Limpiar"><i class="fas fa-eraser"></i></button>
        <button class="btn" onclick="exportImage()" title="Exportar"><i class="fas fa-download"></i></button>
    </div>

    <div class="ui-panel toolbar-left">
        <input type="color" id="mainColor" value="#ff00ff" style="width:40px; height:40px; border:none; background:none; cursor:pointer;">
        <input type="range" id="penSize" min="1" max="20" value="5" title="Grosor">
        <button class="btn" onclick="zoomIn()"><i class="fas fa-search-plus"></i></button>
        <button class="btn" onclick="zoomOut()"><i class="fas fa-search-minus"></i></button>
    </div>

    <input type="file" id="file-input" style="display:none" accept="image/*">

    <div id="master-container">
        <div id="infinite-canvas">
            <div class="grid-bg"></div>
            <svg id="svg-layer"></svg>
            <canvas id="draw-layer"></canvas>
            </div>
    </div>

    <script>
        const canvas = document.getElementById('draw-layer');
        const ctx = canvas.getContext('2d');
        const infiniteCanvas = document.getElementById('infinite-canvas');
        const master = document.getElementById('master-container');
        const svgLayer = document.getElementById('svg-layer');
        
        let scale = 1;
        let isPanning = false;
        let isDrawing = false;
        let currentTool = 'pan'; 
        let startX, startY;
        let connections = [];

        // Inicializar tamaño del lienzo de dibujo
        function init() {
            canvas.width = 5000;
            canvas.height = 5000;
            svgLayer.setAttribute('viewBox', '0 0 5000 5000');
        }
        init();

        // Herramientas
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tool).classList.add('active');
            
            if(tool === 'draw') {
                canvas.classList.add('active');
                master.style.cursor = 'crosshair';
            } else {
                canvas.classList.remove('active');
                master.style.cursor = 'grab';
            }
        }

        // Movimiento de la Pizarra (Panning)
        master.onmousedown = (e) => {
            if(currentTool === 'pan' || e.button === 1) {
                isPanning = true;
                startX = e.clientX - infiniteCanvas.offsetLeft;
                startY = e.clientY - infiniteCanvas.offsetTop;
                master.style.cursor = 'grabbing';
            }
        };

        window.onmousemove = (e) => {
            if(isPanning) {
                infiniteCanvas.style.left = (e.clientX - startX) + 'px';
                infiniteCanvas.style.top = (e.clientY - startY) + 'px';
            }
        };

        window.onmouseup = () => {
            isPanning = false;
            if(currentTool === 'pan') master.style.cursor = 'grab';
        };

        // Zoom
        function zoomIn() { scale += 0.1; updateTransform(); }
        function zoomOut() { if(scale > 0.2) scale -= 0.1; updateTransform(); }
        function updateTransform() {
            infiniteCanvas.style.transform = `scale(${scale})`;
        }

        // Dibujo
        canvas.onmousedown = (e) => {
            if(currentTool !== 'draw') return;
            isDrawing = true;
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            ctx.moveTo((e.clientX - rect.left)/scale, (e.clientY - rect.top)/scale);
        };

        canvas.onmousemove = (e) => {
            if(!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo((e.clientX - rect.left)/scale, (e.clientY - rect.top)/scale);
            ctx.strokeStyle = document.getElementById('mainColor').value;
            ctx.lineWidth = document.getElementById('penSize').value;
            ctx.lineCap = 'round';
            ctx.stroke();
        };

        canvas.onmouseup = () => isDrawing = false;

        // Crear Elementos
        function createBox(type, content = "Texto...") {
            const el = document.createElement('div');
            el.className = `element ${type === 'note' ? 'note-pro' : 'node-pro'}`;
            // Posicionar en el centro de la vista actual
            el.style.left = (Math.abs(infiniteCanvas.offsetLeft) + window.innerWidth/2) + 'px';
            el.style.top = (Math.abs(infiniteCanvas.offsetTop) + window.innerHeight/2) + 'px';
            
            el.innerHTML = `
                <div style="display:flex; justify-content:flex-end; gap:5px; font-size:12px;">
                    <i class="fas fa-plus-circle" onclick="addChild(this.parentElement.parentElement)" style="cursor:pointer"></i>
                    <i class="fas fa-trash" onclick="this.parentElement.parentElement.remove(); updateConnections();" style="cursor:pointer"></i>
                </div>
                <div class="content-area" contenteditable="true">${content}</div>
            `;
            
            infiniteCanvas.appendChild(el);
            makeDraggable(el);
            new ResizeObserver(() => updateConnections()).observe(el);
            return el;
        }

        function addNote() { createBox('note', 'Nueva Idea'); }
        function addNode() { createBox('node', 'Concepto'); }

        function addChild(parent) {
            const child = createBox('node', 'Hijo');
            child.style.left = (parseInt(parent.style.left) + 300) + 'px';
            child.style.top = parent.style.top;
            connections.push({from: parent, to: child});
            updateConnections();
        }

        // Drag & Drop de elementos
        function makeDraggable(el) {
            let p1, p2, p3, p4;
            el.onmousedown = (e) => {
                if(e.target.contentEditable === "true") return;
                e.stopPropagation();
                p3 = e.clientX; p4 = e.clientY;
                document.onmousemove = (e) => {
                    p1 = (p3 - e.clientX) / scale;
                    p2 = (p4 - e.clientY) / scale;
                    p3 = e.clientX; p4 = e.clientY;
                    el.style.top = (el.offsetTop - p2) + "px";
                    el.style.left = (el.offsetLeft - p1) + "px";
                    updateConnections();
                };
                document.onmouseup = () => { document.onmousemove = null; };
            };
        }

        // Conexiones Curvas (Miro Style)
        function updateConnections() {
            svgLayer.innerHTML = '';
            connections.forEach(c => {
                if(!c.from.parentElement || !c.to.parentElement) return;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const x1 = c.from.offsetLeft + c.from.offsetWidth;
                const y1 = c.from.offsetTop + c.from.offsetHeight / 2;
                const x2 = c.to.offsetLeft;
                const y2 = c.to.offsetTop + c.to.offsetHeight / 2;
                
                const d = `M ${x1} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2} ${y2}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#ff00ff');
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                svgLayer.appendChild(path);
            });
        }

        // Imagenes
        document.getElementById('file-input').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imgWrap = document.createElement('div');
                imgWrap.className = 'element';
                imgWrap.style.left = (Math.abs(infiniteCanvas.offsetLeft) + 200) + 'px';
                imgWrap.style.top = (Math.abs(infiniteCanvas.offsetTop) + 200) + 'px';
                imgWrap.innerHTML = `<img src="${ev.target.result}" style="width:100%; pointer-events:none; border-radius:8px;">`;
                infiniteCanvas.appendChild(imgWrap);
                makeDraggable(imgWrap);
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function clearAll() {
            if(confirm("¿Borrar todo?")) {
                ctx.clearRect(0,0,5000,5000);
                document.querySelectorAll('.element').forEach(e => e.remove());
                connections = []; updateConnections();
            }
        }

        function exportImage() {
            const link = document.createElement('a');
            link.download = 'pink-ultra-board.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Setup inicial de herramienta
        setTool('pan');
    </script>
</body>
</html>
