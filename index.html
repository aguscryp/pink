<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pink - Miro Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-canvas: #f4f4f9;
            --pink-main: #ffb7ff;
            --sidebar-dark: #1e1e2d;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --note-yellow: #fff9c4;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--bg-canvas); overflow: hidden; }

        /* Panel Lateral Pro */
        .sidebar {
            position: fixed; left: 15px; top: 50%; transform: translateY(-50%);
            width: 65px; background: var(--sidebar-dark); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; padding: 20px 0;
            gap: 20px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: 0.3s;
        }

        .tool-btn {
            width: 45px; height: 45px; border-radius: 12px; border: none;
            background: transparent; color: #a2a2b5; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            transition: 0.2s; position: relative;
        }

        .tool-btn:hover { background: rgba(255,183,255,0.2); color: var(--pink-main); }
        .tool-btn.active { background: var(--pink-main); color: #1e1e2d; }

        /* Lienzo Principal */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; z-index: 5; cursor: crosshair; }
        #svg-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 2; }

        /* Estilo de Notas y Esquemas (Miro Style) */
        .element {
            position: absolute; min-width: 160px; min-height: 100px;
            padding: 15px; border-radius: 8px; box-shadow: var(--shadow);
            z-index: 10; cursor: move; display: flex; flex-direction: column;
            background: white; border: 1px solid rgba(0,0,0,0.05);
            resize: both; overflow: hidden; transition: box-shadow 0.2s;
        }

        .element:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        
        .note { background: var(--note-yellow); border-bottom: 3px solid #fbc02d; }
        .node { border: 2px solid #5c5cff; border-radius: 50px; text-align: center; justify-content: center; }

        .el-body { 
            outline: none; font-size: 14px; color: #333; line-height: 1.4; 
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
        }

        /* Botones flotantes de los elementos */
        .el-ctrl {
            position: absolute; top: -10px; right: -10px; display: none; gap: 5px;
        }
        .element:hover .el-ctrl { display: flex; }
        .ctrl-btn {
            width: 24px; height: 24px; border-radius: 50%; border: none;
            background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 10px;
        }

        /* Input de imagen invisible */
        #imageInput { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <button class="tool-btn" title="Pincel" onclick="setMode('draw')"><i class="fas fa-pencil-alt"></i></button>
        <button class="tool-btn" title="Nota" onclick="addNote()"><i class="fas fa-sticky-note"></i></button>
        <button class="tool-btn" title="Esquema" onclick="addNode()"><i class="fas fa-project-diagram"></i></button>
        <button class="tool-btn" title="Imagen" onclick="document.getElementById('imageInput').click()"><i class="fas fa-image"></i></button>
        <div style="width: 30px; height: 1px; background: rgba(255,255,255,0.1);"></div>
        <input type="color" id="colorPicker" value="#5c5cff" style="width:30px; border:none; background:none; cursor:pointer;">
        <button class="tool-btn" onclick="clearAll()"><i class="fas fa-trash"></i></button>
    </div>

    <input type="file" id="imageInput" accept="image/*">

    <div id="viewport">
        <svg id="svg-canvas"></svg>
        <canvas id="board"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('board');
        const ctx = canvas.getContext('2d');
        const viewport = document.getElementById('viewport');
        const svg = document.getElementById('svg-canvas');
        let connections = [];
        let drawing = false;

        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
        }
        window.onresize = init;
        init();

        // Lógica de Dibujo
        canvas.onmousedown = () => drawing = true;
        canvas.onmouseup = () => { drawing = false; ctx.beginPath(); };
        canvas.onmousemove = (e) => {
            if(!drawing) return;
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineTo(e.clientX, e.clientY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX, e.clientY);
        };

        // Crear Elementos
        function createBox(type, x, y, parent = null) {
            const el = document.createElement('div');
            el.className = `element ${type}`;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            el.innerHTML = `
                <div class="el-ctrl">
                    <button class="ctrl-btn" onclick="this.closest('.element').remove(); updateLines();"><i class="fas fa-times"></i></button>
                    ${type === 'node' ? `<button class="ctrl-btn" onclick="addChild(this)"><i class="fas fa-plus"></i></button>` : ''}
                </div>
                <div class="el-body" contenteditable="true">Texto...</div>
            `;

            viewport.appendChild(el);
            makeDraggable(el);
            new ResizeObserver(() => updateLines()).observe(el);

            if(parent) {
                connections.push({from: parent, to: el});
                updateLines();
            }
            return el;
        }

        function addNote() { createBox('note', 200, 200); }
        function addNode() { createBox('node', 400, 200); }

        function addChild(btn) {
            const parent = btn.closest('.element');
            const child = createBox('node', parent.offsetLeft + 250, parent.offsetTop + 50, parent);
        }

        // Subir e Insertar Imagen
        document.getElementById('imageInput').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgWrap = document.createElement('div');
                imgWrap.className = 'element';
                imgWrap.style.width = '250px';
                imgWrap.style.padding = '0';
                imgWrap.innerHTML = `
                    <div class="el-ctrl"><button class="ctrl-btn" onclick="this.closest('.element').remove()"><i class="fas fa-times"></i></button></div>
                    <img src="${event.target.result}" style="width:100%; border-radius:8px;">
                `;
                viewport.appendChild(imgWrap);
                makeDraggable(imgWrap);
            }
            reader.readAsDataURL(e.target.files[0]);
        };

        function makeDraggable(el) {
            let p1, p2, p3, p4;
            el.onmousedown = (e) => {
                if(e.target.classList.contains('el-body')) return;
                p3 = e.clientX; p4 = e.clientY;
                document.onmousemove = (e) => {
                    p1 = p3 - e.clientX; p2 = p4 - e.clientY;
                    p3 = e.clientX; p4 = e.clientY;
                    el.style.top = (el.offsetTop - p2) + "px";
                    el.style.left = (el.offsetLeft - p1) + "px";
                    updateLines();
                };
                document.onmouseup = () => document.onmousemove = null;
            };
        }

        function updateLines() {
            svg.innerHTML = '';
            connections.forEach(c => {
                if(!c.from.parentElement || !c.to.parentElement) return;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const x1 = c.from.offsetLeft + c.from.offsetWidth;
                const y1 = c.from.offsetTop + c.from.offsetHeight / 2;
                const x2 = c.to.offsetLeft;
                const y2 = c.to.offsetTop + c.to.offsetHeight / 2;
                
                // Línea curva estilo Miro
                const d = `M ${x1} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2} ${y2}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#5c5cff');
                path.setAttribute('fill', 'transparent');
                path.setAttribute('stroke-width', '2');
                svg.appendChild(path);
            });
        }

        function clearAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelectorAll('.element').forEach(e => e.remove());
            connections = []; updateLines();
        }
    </script>
</body>
</html>
